{{ define "create-modal" }}
  <div id="create-modal" class="modal">
    <div class="modal-content">
      <h2 class="header">Create ketchup</h2>

      <form method="POST" action="/app/ketchups/">
        <input type="hidden" name="method" value="POST">

        <p class="padding no-margin">
          <label for="create-name" class="block">Name:</label>
          <input id="create-name" type="text" name="repository" placeholder="ViBiOh/ketchup" value="{{ .Version }}">
        </p>

        <p class="padding no-margin">
          <label for="create-version" class="block">My version:</label>
          <input id="create-version" type="text" name="version" placeholder="1.0.0">
        </p>

        {{ template "form_buttons" "Create" }}
      </form>
    </div>
  </div>
{{ end }}

{{ define "edit-modal" }}
  <div id="edit-modal-{{ .Repository.ID }}" class="modal">
    <div class="modal-content">
      <h2 class="header">Edit ketchup</h2>

      <p class="no-margin center padding">{{ .Repository.Name }}</p>

      <form method="POST" action="/app/ketchups/{{ .Repository.ID }}">
        <input type="hidden" name="method" value="PUT">

        <p class="padding no-margin">
          <label for="edit-version-{{ .Repository.ID }}" class="block">My version:</label>
          <input id="edit-version-{{ .Repository.ID }}" name="version" type="text" value="{{ .Version }}">
        </p>

        {{ template "form_buttons" "Edit" }}
      </form>
    </div>
  </div>
{{ end }}

{{ define "delete-modal" }}
  <div id="delete-modal-{{ .Repository.ID }}" class="modal">
    <div class="modal-content">
      <h2 class="header">Confirmation</h2>

      <form method="POST" action="/app/ketchups/{{ .Repository.ID }}">
        <input type="hidden" name="method" value="DELETE">

        <p class="padding no-margin center">
          Are you sure you want to delete <strong>{{ .Repository.Name }}</strong>?
        </p>

        {{ template "form_buttons" "Delete" }}
      </form>
    </div>
  </div>
{{ end }}

{{ define "ketchups" }}
<style>
  {{ range .Ketchups }}
    #delete-modal-{{ .Repository.ID }}:target,
    #edit-modal-{{ .Repository.ID }}:target,
  {{ end }}
  #create-modal:target {
    display: flex;
    z-index: 5;
  }

  {{ range .Ketchups }}
    #delete-modal-{{ .Repository.ID }}:target ~ .content,
    #edit-modal-{{ .Repository.ID }}:target ~ .content,
  {{ end }}
  #create-modal:target ~ .content {
    display: flex;
    z-index: 5;
  }

  .ketchup__action {
    align-items: center;
    display: flex;
  }

  .ketchup__action .message {
    display: inline-block;
    flex: 1 1;
    flex-basis: auto;
  }

  .ketchups {
    display: grid;
    grid-gap: .5rem;
    grid-template-columns: repeat(auto-fill, minmax(24rem, 1fr));
    margin: .5rem;
  }

  .ketchup {
    border: 1px solid var(--success);
    display: inline-flex;
    flex-direction: column;
    height: 15rem;
  }

  .ketchup--outdated {
    border-color: var(--danger);
  }

  .ketchup__version {
    align-items: center;
    display: flex;
    flex: 1 1;
    flex-basis: auto;
    justify-content: center;
  }

  .ellipsis {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .block {
    display: block;
  }

  .inline {
    display: inline-block;
  }

  .small {
    font-size: 1.6rem;
  }
</style>

<script>
    /**
     * Go back from state.
     */
    function goBack() {
      const previousHash = document.location.hash;
      document.location.hash = '';

      if (/success$/gim.test(previousHash)) {
        window.location.reload(true);
      }
    }

    /**
     * Handle Previous/next.
     */
    window.onkeyup = e => {
      switch(e.key) {
        case 'Escape':
          goBack();
          break;
      }
    };
</script>

<div class="ketchup__action">
  {{ template "create-modal" }}
  <p class="padding no-margin inline">
    <a href="#create-modal" class="button bg-primary">Create</a>
  </p>

  {{ template "message" .Message }}
</div>

<article class="ketchups">
  {{ range .Ketchups }}
    {{ template "edit-modal" . }}
    {{ template "delete-modal" . }}

    <div class="ketchup center {{ if ne .Version .Repository.Version }}ketchup--outdated{{ end }}">
      <h2 class="header small ellipsis">{{ .Repository.Name }}</h2>

      {{ if .Semver }}
        <p class="no-margin padding">
          {{ .Semver }}
        </p>
      {{ end }}

      <div class="ketchup__version">
        <span class="{{ if ne .Version .Repository.Version }}danger{{ else }}success{{ end }}">
          {{ .Version }}
        </span>

        {{ if ne .Version .Repository.Version }}
          <span>
            &nbsp;->&nbsp;<a class="success" href="https://github.com/{{ .Repository.Name }}/releases/tag/{{ .Repository.Version }}" target="_blank" rel="noopener noreferrer">{{ .Repository.Version }}</a>
          </span>
        {{ end }}
      </div>

      <div>
        {{ if ne .Version .Repository.Version }}
          <a href="https://github.com/{{ .Repository.Name }}/compare/{{ .Version }}...{{ .Repository.Version }}" target="_blank" rel="noreferrer noopener" class="button button-icon target__action" title="Compare">
            <img class="icon" src="/svg/eyes?fill=silver" alt="Compare icon">
          </a>

          <form method="POST" action="/app/ketchups/{{ .Repository.ID }}" class="inline">
            <input type="hidden" name="method" value="PUT">
            <input type="hidden" name="version" value="{{ .Repository.Version }}">

            <button type="submit" class="button button-icon" title="Update to latest">
              <img class="icon" src="/svg/circle-up?fill=silver" alt="Update icon">
            </button>
          </form>
        {{ end }}

        <a href="#edit-modal-{{ .Repository.ID }}" class="button button-icon target__action" title="Edit">
          <img class="icon" src="/svg/edit?fill=silver" alt="Edit icon">
        </a>
        <a href="#delete-modal-{{ .Repository.ID }}" class="button button-icon target__action" title="Delete">
          <img class="icon" src="/svg/times?fill=silver" alt="Delete icon">
        </a>
      </div>
    </div>
  {{ end }}
</article>
{{ end }}
